name: PR Checks

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python (for uv)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install shfmt
        run: |
          wget -q -O shfmt \
            https://github.com/mvdan/sh/releases/latest/download/shfmt_v3.7.0_linux_amd64
          chmod +x shfmt
          sudo mv shfmt /usr/local/bin/

      - name: Check formatting
        run: |
          echo "## Format Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking formatting..." >> $GITHUB_STEP_SUMMARY

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Run formatters
          make format-bash || true
          make format-markdown || true

          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ Formatting check failed: files need formatting" >> \
              $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following files need formatting:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Run \`make format\` locally and commit." >> \
              $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All files are properly formatted" >> $GITHUB_STEP_SUMMARY
          fi

  lint-bash:
    name: Lint Bash
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run bash linting
        run: |
          echo "## Bash Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          set +e
          make lint-bash 2>&1 | tee lint-output.txt
          LINT_EXIT=${PIPESTATUS[0]}

          if [ $LINT_EXIT -ne 0 ]; then
            echo "âŒ Bash linting failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Address the shellcheck errors above." >> \
              $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Bash linting passed" >> $GITHUB_STEP_SUMMARY
          fi

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run markdown linting
        run: |
          echo "## Markdown Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          set +e
          make lint-markdown 2>&1 | tee lint-output.txt
          LINT_EXIT=${PIPESTATUS[0]}

          if [ $LINT_EXIT -ne 0 ]; then
            echo "âŒ Markdown linting failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fix:** Address the markdownlint errors above." >> \
              $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… Markdown linting passed" >> $GITHUB_STEP_SUMMARY
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install bats-core
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats-core
          sudo /tmp/bats-core/install.sh /usr/local

      - name: Run tests
        run: |
          echo "## Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          set +e
          make test 2>&1 | tee test-output.txt
          TEST_EXIT=${PIPESTATUS[0]}

          if [ $TEST_EXIT -ne 0 ]; then
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    name: Check Results
    runs-on: ubuntu-latest
    needs: [format-check, lint-bash, lint-markdown, test]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "# PR Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FORMAT_STATUS="${{ needs.format-check.result }}"
          LINT_BASH_STATUS="${{ needs.lint-bash.result }}"
          LINT_MD_STATUS="${{ needs.lint-markdown.result }}"
          TEST_STATUS="${{ needs.test.result }}"

          if [ "$FORMAT_STATUS" = "success" ]; then
            echo "âœ… **Format Check:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Format Check:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$LINT_BASH_STATUS" = "success" ]; then
            echo "âœ… **Bash Linting:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Bash Linting:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$LINT_MD_STATUS" = "success" ]; then
            echo "âœ… **Markdown Linting:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Markdown Linting:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TEST_STATUS" = "success" ]; then
            echo "âœ… **Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Tests:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$FORMAT_STATUS" != "success" ] || \
             [ "$LINT_BASH_STATUS" != "success" ] || \
             [ "$LINT_MD_STATUS" != "success" ] || \
             [ "$TEST_STATUS" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some checks failed. Review individual job outputs.**" >> \
              $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          fi